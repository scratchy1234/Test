# 六爻多智能体工作流原型

## 1. 目标概述
- **用途**：基于用户提供的六爻盘面信息，按照指定主题（如健康、投资、运势、决策、爱情）输出结构化的中文解读。
- **核心能力**：
  1. 校验与标准化输入字段。
  2. 从六爻知识库中检索相关卦义、六亲六神、动变关系等信息。
  3. 针对不同主题，生成含有 TL;DR、盘面复述、卦象分析、逐爻解读、风险与机遇、建议等板块的报告。
  4. 始终包含免责声明，避免越权建议（如金融操作、医疗诊断等）。

## 2. 输入参数规范
| 字段 | 说明 | 示例 |
| ---- | ---- | ---- |
| 本卦 | 起卦所得主卦（含卦名、上卦、下卦、卦宫/格局） | 乾卦（乾上乾下，八纯） |
| 互卦 | 二三四、三四五爻构成的中间之卦 | 屯卦 |
| 变卦 | 动爻变动后所得卦 | 姤卦 |
| 世 | 世爻位置 | 五爻 |
| 应 | 应爻位置 | 二爻 |
| 六亲 | 对应六亲信息 | 一爻妻财、二爻官鬼... |
| 六神 | 对应六神信息 | 青龙、白虎等 |
| 日月建 | 月令与日支 | 辛卯月、甲午日 |
| 动静爻 | 标记各爻动静 | 三爻动、五爻静 |
| 空亡 | 当前空亡信息 | 子丑空 |
| 特定格局 | 六合/六冲/游魂等 | 六合 |
| 主题 | 健康/投资/运势/决策/爱情 | 投资 |
| 背景 | 详细背景描述 | “准备评估新项目投资” |
| 求问事项 | 一句话概括需求 | “是否应投资该项目” |
| 起卦时间 | YYYY-MM-DD HH:mm + 干支（北京时区） | 2024-06-16 09:30 庚辰年壬午月乙酉日己巳时 |
| 六爻盘面 | 六个爻的详细字段（伏神/六亲/六神/动静/变卦等） | 结构化 JSON 或表格 |

> 建议在 Agent Builder 中将输入表单拆分为“基础卦象信息”“主题与意图”“六爻盘面明细”三个区块，确保字段齐全。

## 3. 智能体角色设计
| 智能体 | 职责 | 核心输入 | 关键输出 |
| ------ | ---- | -------- | -------- |
| Agent A：资料校验官 | 校验字段完整性、格式化时间至北京时间、生成结构化上下文对象 | 原始输入 | 标准化 JSON、缺失项警告、北京时区转换后的时间戳 |
| Agent B：卦理解析师 | 结合知识库，推断卦象关键点（本卦/互卦/变卦、用神、动静、空亡等） | 标准化 JSON、知识库检索结果 | 卦理要点清单、用神与旺衰、动爻关系、时间锚点 |
| Agent C：主题策划师 | 按主题整合解读结构，输出最终报告 | 卦理要点、主题指引模板、背景/求问事项 | 结构化中文报告（各板块内容）、风险&建议清单 |
| Agent D：合规审校员（可选） | 检查是否含禁止建议、缺失免责声明 | 初稿报告 | 调整建议/最终确认版本 |

### Agent A：资料校验官 Prompt 核心
- 明确要求：
  - 验证所有必填字段；指出缺失或异常（如时间非北京时区）。
  - 解析 `六爻盘面` 为标准化数据结构（如数组形式的 JSON）。
  - 输出 `normalized_payload` 与 `validation_notes`。

### Agent B：卦理解析师 Prompt 核心
- 输入：`normalized_payload`、知识库检索结果（包含卦辞、爻辞、六亲属性、六神特性、空亡规则）。
- 输出：
  - `core_insights`：列出本卦、互卦、变卦、特定格局的关键含义。
  - `useful_lines`：标记动爻、伏神、冲合刑害信息，并关联时间窗口。
  - `topic_mapping`：根据主题判定用神及支持度，给出旺衰理由。

### Agent C：主题策划师 Prompt 核心
- 参考输出格式要求，逐段生成：
  1. 一页摘要（TL;DR）。
  2. 盘面复述（核对区）。
  3. 卦象结构分析。
  4. 用神与爻位。
  5. 核心判断链（3–5 条）。
  6. 逐爻 × 时间段解读（6 段）。
  7. 风险与边界（What NOT to do）。
  8. 机遇（2–4 条）。
  9. 风险（2–4 条）。
  10. 一句总结（≤20 字）。
  11. 建议（实操，限定在当前主题）。
  12. 一句话总结（20–35 字）。
- 必须引用 `core_insights` 与 `topic_mapping`；若信息不足，要在相应段落标记“数据不足”。
- 每份输出附带免责声明：“以上解读仅供参考，请结合自身情况决策。”

### Agent D：合规审校员（可选） Prompt 核心
- 检查是否出现与主题不符的建议（如投资报告出现医疗建议）。
- 确保无过度承诺或保证收益/治愈等词汇。
- 确认已经包含免责声明。
- 输出通过/不通过标记与必要修改建议。

## 4. 知识库准备
1. **基础资料**：
   - 六十四卦卦辞、爻辞、卦象释义（繁/简体皆可）。
   - 六亲属性表、六神含义、空亡/冲合/刑害规则。
   - 主题映射表：不同主题对应的用神及辅助判断逻辑。
   - 现代语境注释：针对投资、健康等主题补充实际案例和注意事项。
2. **结构建议**：
   - 以 JSON/CSV 分层存储，方便 Agent B 检索。
   - 为每个卦象建立唯一 ID（例如 `hexagram_01_qian`）。
   - 预留字段记录出处与版权信息，确保可追溯。
   - 可附加典型案例、现代语境解释（作为补充材料）。

### 4.1 可复用的开源资料（已确认许可证）
| 资源名称 | 简介 | 许可证 | 适用方式 |
| --- | --- | --- | --- |
| [kentang2017/ichingshifa](https://github.com/kentang2017/ichingshifa) | Python 实现的《易经》筮法，涵盖六十四卦与爻辞数据、干支换算、六爻排盘逻辑。 | MIT License | 提取卦辞、爻辞、干支换算方法，转化为知识库原始素材与时间换算工具。 |
| [chengjun/iching](https://github.com/chengjun/iching) | Python 版蓍草起卦工具，含卦象数据与释义。 | MIT License | 作为卦象基础数据来源，可与自有注释合并，形成多语种对照。 |
| [adamblvck/iching-wilhelm-dataset](https://github.com/adamblvck/iching-wilhelm-dataset) | 英文 Wilhelm-Baynes 版《易经》JSON/CSV 数据集。 | MIT License | 用于构建英文摘要、双语输出模块或校验多源解释一致性。 |

> 以上项目均采用 MIT 许可，可在遵守原项目版权声明的前提下复制、修改、再分发。整合时需保留许可证文件并在知识库元数据中记录来源。对于未明确许可证的仓库（如部分六爻笔记），建议仅用于灵感参考，不直接导入。

## 5. 工具与函数调用
- `convert_to_beijing_time`：接收 ISO 时间与时区，返回北京时间与干支换算结果。
- `hexagram_lookup`：根据卦象 ID 返回卦辞、六亲、卦宫等。
- `line_attribute_lookup`：返回各爻的六神、六亲、动静、伏神等说明。
- `topic_use_god_rules`：根据主题返回用神优先级、禁忌建议列表。
- `compliance_check`（可选）：检测输出中敏感词或超范围承诺。

> 在 Agent Builder 中可将上述函数作为外部工具（API）或本地函数引入，Agent B 与 C 可以调用。

## 6. 工作流时序与改进要点
1. **用户输入 → Agent A**：
   - 校验、补全、格式化；若缺失关键字段，直接返回错误信息给用户。
   - 若发现时间未转换为北京时间，调用 `convert_to_beijing_time` 工具进行校正，并更新干支信息。
   - 将验证结果写入 `validation_notes`，供下游参考（例如提示“本卦信息缺少特定格局字段”）。
2. **Agent A → Agent B**：
   - 将 `normalized_payload` 发送给 Agent B，同时附带 `validation_notes`。
   - Agent B 调用 `hexagram_lookup`、`line_attribute_lookup`、`topic_use_god_rules` 等工具，生成卦理要点。
   - 若知识库返回空值或冲突（如同一爻存在多个伏神），在 `core_insights` 中注明异常并抛出 `insight_warnings` 给后续环节。
3. **Agent B → Agent C**：
   - Agent C 根据 `core_insights`、`topic_mapping`、`insight_warnings` 组合最终报告。
   - 若收到严重警告（如“无符合主题的用神”），Agent C 应输出提示并建议用户重新补充信息，而非直接生成建议。
   - 输出末尾自动附上免责声明；若主题与建议不匹配，需在草稿中标注等待审校。
4. **Agent C → Agent D（可选但建议启用）**：
   - 审核通过则输出；未通过则反馈修改点给 Agent C 重写。
   - 审校失败时返回具体提示（如“缺少健康类注意事项”），Agent C 依据提示重新生成。
5. **日志与监控**：
   - 全流程记录关键决策点（用神选择、动爻解释来源），便于事后追溯与模型迭代。
   - 建议引入质量评分（例如对齐模板完整度、风险提示覆盖率），持续优化 Agent 提示词。

> 工作流可通过 Agent Builder 的“条件分支”实现循环重写：当 Agent D 判定不合格时，自动回流至 Agent C 重试，并限制最大重试次数避免死循环。

### 6.1 数据流与状态追踪
- **会话上下文对象**：`context = { normalized_payload, validation_notes, core_insights, topic_mapping, insight_warnings, draft_report, compliance_result }`
- **状态机**：`INPUT_VALIDATION → HEXAGRAM_ANALYSIS → THEME_REPORT → COMPLIANCE_REVIEW → OUTPUT`
- **失败回退策略**：
  - 若 `INPUT_VALIDATION` 失败 → 返回用户补充信息；
  - 若 `HEXAGRAM_ANALYSIS` 失败 → Agent B 请求补充知识库或提示手动确认；
  - 若 `THEME_REPORT` 失败 → Agent C 重写（限制 2 次）；
  - 若 `COMPLIANCE_REVIEW` 失败 → Agent C 重写，必要时通知人工复核。

## 7. 示例输入片段（JSON）
```json
{
  "本卦": {"卦名": "乾", "上卦": "乾", "下卦": "乾", "宫": "乾宫", "特定格局": "八纯"},
  "互卦": {"卦名": "屯"},
  "变卦": {"卦名": "姤"},
  "世": "五爻",
  "应": "二爻",
  "六亲": ["兄弟", "父母", "官鬼", "妻财", "子孙", "父母"],
  "六神": ["青龙", "朱雀", "勾陈", "腾蛇", "白虎", "玄武"],
  "日月建": {"月建": "壬午", "日建": "乙酉"},
  "动静爻": ["静", "动", "静", "静", "动", "静"],
  "空亡": "子丑空",
  "主题": "投资",
  "背景": "计划对新技术项目进行资金投入，时间紧张。",
  "求问事项": "是否应在本季度启动投资？",
  "起卦时间": {"原始输入": "2024-06-16 09:30 GMT+8", "干支": "甲辰年壬午月乙酉日己巳时"},
  "六爻盘面": [
    {"爻位": 1, "本卦六亲": "兄弟", "本卦阴阳": "阳", "六神": "青龙", "动静": "静", "伏神": "子孙", "变卦六亲": "兄弟"},
    {"爻位": 2, "本卦六亲": "父母", "本卦阴阳": "阴", "六神": "朱雀", "动静": "动", "伏神": "妻财", "变卦六亲": "子孙"}
    // ...其余 4 爻
  ]
}
```

## 8. 输出示例骨架
```
一页摘要（TL;DR）
- 主题结论：本卦乾卦主进取，互卦屯提示初始阻力，变卦姤预示机遇突现。
- 关键要点：① 用神妻财得日建相生；② 三爻动化姤，需把握突发合作；③ 子丑空对资金到位有延迟。
- 时间窗口：上午 9-11 时势能最旺；午后需谨慎。

盘面复述（核对区）
- 本卦：乾为天，乾宫八纯，格局主持续上升。
- 互卦：屯，象征开局艰难；需稳扎稳打。
- 变卦：姤，动爻引发突如其来的相遇或合作。
- 世爻/应爻：世居五爻旺位，应在二爻受日建助。

卦象结构分析
...
```

## 9. 免责声明与合规要求
- 所有输出末尾附加：“以上解读仅供参考，请结合自身实际情况判断，如涉及重大决策请咨询专业人士。”
- 禁止出现明确的投资收益保证、绝对性医疗结论、替代法律意见等。
- 若用户追问超出主题的建议，应提示需重新起卦或更换主题。
- 针对健康主题，额外提示“如涉及身体不适，请及时就医”；针对投资主题，提示“市场有风险，投资需谨慎”。
- 建议为 Agent D 配置可更新的敏感词/禁用建议列表，并定期复盘。

## 10. 评估与持续迭代
- **自动化测试用例**：针对不同主题准备标准输入，验证输出模板是否完整、免责声明是否出现、用神选择是否符合规则。
- **人工评审清单**：审查卦理解释是否引用知识库来源、是否出现文化敏感或迷信绝对论述。
- **指标追踪**：统计各主题的满意度、重写次数、合规拒绝率，作为 Prompt 与知识库更新依据。
- **版本管理**：知识库、Prompt、工具函数分别维护版本号，部署前执行回归测试。
- **上线准备**：与产品前端约定输出 JSON Schema，确保可视化组件能稳定渲染每个板块。

## 11. 下一步扩展方向
- 增设多语言支持（中文输出、可选英文概要）。
- 引入用户画像模块，记录历史起卦与反馈。
- 搭配情绪分析 Agent，针对用户背景提供更柔性措辞。
- 加入案例库比对，提供“相似案例结局”作为参考。
```

该文档可直接导入 Agent Builder 项目作为设计蓝图，逐步替换为实际 Prompt、工具调用与测试用例。
