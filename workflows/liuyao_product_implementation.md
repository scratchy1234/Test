# 六爻多智能体产品化实施方案

## 1. 产品定位与用户体验
- **目标用户**：对易经六爻有兴趣的个人占测者、咨询顾问、文化内容平台。
- **核心场景**：用户输入完整的六爻盘面与求测背景，系统提供结构化、可视化的主题化解读报告，并留存历史记录。
- **用户旅程**：
  1. 登录/注册 → 选择主题 → 填写或导入盘面 → 校验与提示 → 查看报告 → 收藏/分享 → 评价反馈。
  2. 支持从移动端 H5 与桌面端 Web 同步访问；关键节点提供引导提示（空字段、高风险提示等）。

## 2. 技术架构总览
```
┌───────────┐       ┌──────────────────────┐
│  前端 Web  │<---->│    REST/GraphQL API   │<----------------┐
└───────────┘       ├──────────────────────┤                 │
                     │  Orchestrator (Agents)│                 │
                     └────────┬─────────────┘                 │
                              │                               │
         ┌──────────┬─────────┴─────────┬──────────────┐      │
         │输入校验服务│卦象解析服务        │报告生成服务    │      │
         └──────────┴─────────┬─────────┴──────────────┘      │
                              │                               │
                     ┌────────▼────────┐            ┌────────▼────────┐
                     │ 六爻知识库/检索层 │            │ 日志&评估服务       │
                     └────────┬────────┘            └────────┬────────┘
                              │                               │
                     ┌────────▼────────┐            ┌────────▼────────┐
                     │ 数据存储 (Postgres│            │ 监控/告警 (Prom+│
                     │ + S3/OSS)        │            │ Grafana)        │
                     └──────────────────┘            └──────────────────┘
```
- **编排层**：采用 OpenAI Agent Builder 或自建 orchestrator（LangChain/Flowise）。
- **通信协议**：内部使用事件总线（如 RabbitMQ）或直接 API 调用。所有服务暴露 gRPC/REST 接口方便扩展。

## 3. 数据与知识库实现
### 3.1 数据模型
- `hexagrams`：卦名、上卦、下卦、卦宫、象辞、卦辞来源、许可证。
- `lines`：卦 ID、爻位、六亲、六神、动静规则、爻辞、象辞、冲合刑害信息。
- `special_patterns`：格局名称、判定条件、象征意义、适用主题。
- `theme_rules`：主题 → 用神优先级、禁忌建议词、补充免责声明。
- `sessions`：用户输入原文、标准化 payload、生成报告、风险标签。

### 3.2 知识库构建流程
1. **数据抽取**：从已确认 MIT 许可的项目导出 JSON/CSV → 使用 ETL 脚本统一字段。
2. **清洗与去重**：
   - 统一繁简体（OpenCC）。
   - 标记出处与许可证，写入 `source_meta` 字段。
3. **索引构建**：
   - 关系型数据库存储结构化数据。
   - 启用向量索引（如 pgvector / Pinecone）保存注释、案例。
4. **版本管理**：知识库引入 `dataset_version`，采用 Git LFS 或 DVC 追踪。
5. **安全策略**：所有数据来源需经过版权复审，自动检查许可证字段是否齐全。

## 4. 多智能体落地方案
### 4.1 Orchestrator 状态机
| 状态 | 触发 | 说明 |
| ---- | ---- | ---- |
| `INTAKE` | 用户提交表单 | 前端调用 API，写入 `sessions` 表。|
| `VALIDATING` | Agent A 处理 | 调用输入校验服务；失败则返回 `NEEDS_FIX`。|
| `ANALYZING` | Agent B 处理 | 调用卦象解析服务，落地 `core_insights`。|
| `REPORTING` | Agent C 生成 | 生成结构化报告与 Markdown/JSON 双份输出。|
| `REVIEWING` | Agent D 审核 | 通过则进入 `DONE`，否则回退至 `REPORTING`。|
| `ESCALATED` | 人工复核 | 监测到高风险（健康急症等）即触发。|

### 4.2 Prompt 模板（示例）
- **Agent A**：
  ```text
  你是严谨的资料校验官。收到用户提交的六爻占卜字段，请：
  1. 校验每个必填项是否存在；
  2. 将起卦时间统一为北京时间 ISO8601 与对应干支；
  3. 输出 JSON：{ "normalized_payload": {...}, "validation_notes": [...], "status": "ok|needs_fix" }。
  如果缺失字段或格式异常，在 notes 中给出中文提示，不要自行猜测。
  ```
- **Agent B**：
  ```text
  你是资深六爻解析师。根据 normalized_payload 与知识库检索结果，完成：
  - 识别本卦/互卦/变卦的关键象义与特定格局；
  - 判定主题对应的用神，给出旺衰、助制与冲合；
  - 生成 core_insights、topic_mapping、insight_warnings JSON。
  若知识不足，请在 warnings 中说明，不编造信息。
  ```
- **Agent C**：
  ```text
  你是结构化报告撰写者，请严格按照模板生成中文输出。
  输入：core_insights、topic_mapping、background、question、theme。
  要求：
  1. 逐段输出 Markdown，12 个板块全部覆盖。
  2. 未知信息以“数据不足”填充。
  3. 在建议部分仅针对当前主题给出 3-5 条可执行点。
  4. 末尾附加“以上解读仅供参考，请结合自身情况决策。”
  输出 JSON：{ "markdown_report": "...", "structured_sections": {...}, "rewrite_required": bool }。
  ```
- **Agent D**：
  ```text
  你是合规与质量审校员，请检查：
  - 是否包含模板全部段落；
  - 是否出现越权词汇、绝对化承诺；
  - 主题与建议是否匹配；
  - 免责声明是否存在。
  输出 JSON：{ "status": "approved|reject", "issues": [...], "risk_level": "low|medium|high" }。
  ```

### 4.3 工具服务接口
- `POST /api/convert-time` → 输入时间字符串与时区 → 返回北京时间与干支信息。
- `POST /api/hexagram-insights` → 输入卦象 ID、动爻 → 返回卦辞、六亲、旺衰数据。
- `POST /api/theme-rules` → 输入主题 → 返回用神映射与禁忌列表。
- `POST /api/compliance-scan` → 对生成文本做敏感词检测、主题一致性校验。

## 5. 前端与可视化
### 5.1 表单设计
- **步骤条**：`基础信息 → 卦象详情 → 主题选择 → 预览 & 提交`。
- **实时校验**：对起卦时间、动静标记进行即时提示；导入 JSON 时显示解析结果。
- **历史记录**：为登录用户提供占测历史列表，可点击查看报告、下载 PDF。

### 5.2 报告展示
- 左侧 TL;DR 与风险提示的卡片式布局，右侧展开详细段落。
- 提供“时间段时间轴”组件展示逐爻 × 时间段解读。
- 支持导出 Markdown/PDF，分享时自动隐去敏感信息。

## 6. 安全与合规
- **内容审查**：合规服务维护禁用词库（投资收益保证、医疗治愈等），每日更新。
- **身份验证**：OAuth2 / JWT；对高频占测加验证码或速率限制。
- **日志留存**：将 `core_insights`、`structured_sections` 与 `compliance_result` 写入审计表。
- **用户告知**：隐私政策中说明仅作文化参考；健康主题提醒寻求医生帮助，投资主题提醒风险。

## 7. 测试与发布流程
1. **单元测试**：覆盖时间转换、知识库检索、禁用词检测等工具函数（Python pytest）。
2. **集成测试**：模拟完整会话，验证状态机流转、重试逻辑、审校回退。
3. **人测脚本**：准备至少 20 组不同主题的真实/模拟盘面，标记预期解读要点。
4. **评估指标**：
   - 模板完整度 ≥ 0.98；
   - 审校驳回率 < 15%；
   - 用户主观满意度（问卷）≥ 4.2/5。
5. **灰度发布**：
   - 内部试运行 → 受邀测试 → 正式上线；
   - 上线前完成安全审计与隐私评估。

## 8. 运维与监控
- **监控指标**：响应时间、错误率、重试次数、知识库命中率、审校风险等级分布。
- **报警策略**：当高风险输出连续出现 >3 次或知识库命中率 <70% 时通知团队。
- **数据备份**：每日备份数据库与知识库快照，保留 30 天滚动窗口。
- **模型更新**：记录 Prompt/Agent 版本，使用 Feature Flag 控制新版本灰度。

## 9. 里程碑规划
| 阶段 | 时间 | 关键交付 |
| ---- | ---- | ---- |
| P0 原型 | 2 周 | 知识库最小集 + 三个核心 Agent Prompt + 手动触发流程 |
| P1 内测 | 4 周 | 前端表单、自动编排、日志系统、合规审校上线 |
| P2 公测 | 6 周 | 扩充主题规则、上线评估指标、提供 PDF 导出 |
| P3 正式版 | 8 周 | 运维监控完善、支持用户画像、API 商业化 |

## 10. 实施清单
- [ ] 建立 Git 仓库与 CI/CD（lint + pytest + playwright）。
- [ ] 搭建知识库 ETL 管道，导入 MIT 许可数据。
- [ ] 编写工具服务原型（FastAPI）。
- [ ] 在 Agent Builder 配置四个 Agent 与状态流转。
- [ ] 实现前端原型（React/Vue + Tailwind）。
- [ ] 设置日志、监控与审计通道。
- [ ] 准备法律免责声明与隐私条款文案。
- [ ] 安排人测与灰度发布计划。

---
该方案可作为落地产品的行动蓝图，后续可按模块拆解开发任务并进入实现阶段。
